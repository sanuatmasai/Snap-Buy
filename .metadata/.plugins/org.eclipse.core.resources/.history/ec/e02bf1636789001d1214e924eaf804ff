package com.masai.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.masai.dao.CartDao;
import com.masai.dao.CustomerDao;
import com.masai.dao.ProductDao;
import com.masai.dao.SessionDao;
import com.masai.dto.ProductDto;
import com.masai.exceptions.CartException;
import com.masai.exceptions.LoginException;
import com.masai.exceptions.ProductException;
import com.masai.model.Cart;
import com.masai.model.CurrentUserSession;
import com.masai.model.Customer;
import com.masai.model.Product;

@Service
public class CartServiceImpl implements CartService {

	@Autowired
	SessionDao sDao;
	
	@Autowired
	ProductDao pDao;
	
	@Autowired
	CartDao ctDao;
	
	@Autowired
	CustomerDao cDao;
	
	
	@Override
	public Cart addProductToCart(Integer productId, int quantity, String key)
			throws CartException, LoginException, ProductException {
		
		
		CurrentUserSession currentSession = sDao.findByUuid(key);
		
		Customer currentCustomer = cDao.findById(currentSession.getUserId()).get();
		
		if(currentCustomer == null) throw new LoginException("Please login first, to add product to the cart");
		
		Product product = pDao.findById(productId).orElseThrow(() -> new ProductException("Product is not available with id: "+productId));

		if(product.getQuantity() < quantity) throw new ProductException("Out of stock");
		
//		Cart cart = ctDao.findByCustomer(currentCustomer);
		
		Cart cart = currentCustomer.setCart(new Cart());
		if(cart == null) throw new CartException("No Cart is present");
		else
		{
			List<ProductDto> list = cart.getProducts();
			
			ProductDto productDto = new ProductDto( product.getProductId(),
													product.getProductName(),
													product.getPrice(), 
													product.getColor(), 
													product.getDimension(),
													product.getManufacturer(),
													product.getSpecification(),
													quantity);
			
			product.setQuantity(product.getQuantity() - quantity);
			
			list.add(productDto);
			cart.setProducts(list);
			
			ctDao.save(cart) ;
			pDao.save(product);
			 
			return cart;
		}
		
	}
	}

	@Override
	public List<ProductDto> removeProductFromCart(Integer productId, String key)
			throws CartException, ProductException, LoginException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<ProductDto> updateProductQuantity(Integer productId, Integer quantity, String key)
			throws CartException, LoginException, ProductException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public Cart removeAllProducts(String key) throws CartException, LoginException {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public List<ProductDto> viewAllProducts(String key) throws CartException, LoginException {
		// TODO Auto-generated method stub
		return null;
	}

}
